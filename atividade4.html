<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de √Årvores</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/d3@7.8.2/dist/d3.min.js"></script> <!-- Importa o D3.js -->
</head>
<body>
  <h1>Editor de Estruturas de √Årvores</h1>

  <!-- Descri√ß√£o da Atividade -->
  <section class="description">
    <h2>Descri√ß√£o da Atividade</h2>
    <p>Na atividade proposta, voc√™ ir√° construir uma √°rvore que segue a classifica√ß√£o taxon√¥mica de alguns animais. A √°rvore ser√° do tipo:</p>
    <pre><code class="plaintext">
Animalia
  ‚îî‚îÄ‚îÄ Chordata
        ‚îú‚îÄ‚îÄ Mammalia
        ‚îÇ     ‚îú‚îÄ‚îÄ Primates
        ‚îÇ     ‚îÇ     ‚îî‚îÄ‚îÄ Homo sapiens
        ‚îÇ     ‚îî‚îÄ‚îÄ Carnivora
        ‚îÇ           ‚îî‚îÄ‚îÄ Canis lupus
        ‚îî‚îÄ‚îÄ Aves
              ‚îî‚îÄ‚îÄ Passeriformes
                    ‚îî‚îÄ‚îÄ Corvus corax
    </code></pre>

    <p>O objetivo √© validar se a estrutura criada corresponde exatamente √† esperada. Utilize o editor para criar sua √°rvore e clique em "Executar C√≥digo" para verificar sua solu√ß√£o.</p>
  </section>

  <div class="container">
    <div class="editor-container">
      <textarea id="code-editor" placeholder="Escreva seu c√≥digo TypeScript aqui..."></textarea>
      <button id="run-code">Executar C√≥digo</button>
    </div>

    <div id="output-container">
      <h2>Visualiza√ß√£o da √Årvore</h2>
      <div id="tree-output"></div>
      <div class="celebration" id="celebration" style="display: none;">
        üéÜ Parab√©ns! Voc√™ acertou! üéÜ
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/typescript@4.9.4/lib/typescript.js"></script>
  
  <script>
    document.getElementById("run-code")?.addEventListener("click", () => {
      const userCode = document.getElementById("code-editor")?.value;
      const outputDiv = document.getElementById("tree-output");
      const celebrationDiv = document.getElementById("celebration");

      if (userCode && outputDiv) {
        try {
          outputDiv.innerHTML = ""; // Limpa a √°rvore existente antes de renderizar uma nova
          celebrationDiv.style.display = "none"; // Esconde a celebra√ß√£o se a √°rvore n√£o estiver correta

          // Compila o c√≥digo TypeScript para JavaScript
          const compiledCode = ts.transpile(userCode);
          
          // Executa o c√≥digo compilado utilizando eval
          const result = eval(compiledCode);
          
          // Valida√ß√£o da √°rvore gerada
          if (validateTreeStructure(result)) {
            outputDiv.innerHTML = "<span style='color: green;'>√Årvore v√°lida!</span>";
            celebrationDiv.style.display = "block"; // Mostra a celebra√ß√£o se a √°rvore estiver correta
            renderTreeD3(result, outputDiv); // Renderiza a √°rvore com D3.js
          } else {
            throw new Error("Estrutura inv√°lida. A √°rvore deve seguir o formato especificado no enunciado.");
          }
        } catch (error) {
          outputDiv.innerHTML = `<span style="color: red;">Erro: ${error.message}</span>`;
        }
      }
    });

    // Fun√ß√£o para validar a √°rvore com base no enunciado
    function validateTreeStructure(tree) {
      const expectedStructure = {
        value: "Animalia",
        children: [
          {
            value: "Chordata",
            children: [
              {
                value: "Mammalia",
                children: [
                  { value: "Primates", children: [{ value: "Homo sapiens", children: [] }] },
                  { value: "Carnivora", children: [{ value: "Canis lupus", children: [] }] }
                ]
              },
              {
                value: "Aves",
                children: [
                  { value: "Passeriformes", children: [{ value: "Corvus corax", children: [] }] }
                ]
              }
            ]
          }
        ]
      };

      function compareNodes(node, expectedNode) {
        if (node.value !== expectedNode.value) return false;
        if (node.children.length !== expectedNode.children.length) return false;

        for (let i = 0; i < node.children.length; i++) {
          if (!compareNodes(node.children[i], expectedNode.children[i])) return false;
        }
        return true;
      }

      return compareNodes(tree, expectedStructure);
    }

    // Fun√ß√£o para renderizar a √°rvore com D3.js
    function renderTreeD3(tree, container) {
      const width = 600;
      const height = 300;
      const verticalOffset = 50;

      const svg = d3.select(container)
        .append("svg")
        .attr("width", width)
        .attr("height", height + verticalOffset);

      const root = d3.hierarchy(tree);
      const treeLayout = d3.tree().size([width, height - 100]);

      treeLayout(root);

      // Adiciona os links entre os n√≥s
      svg.selectAll(".link")
        .data(root.links())
        .enter()
        .append("line")
        .attr("class", "link")
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y + verticalOffset)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y + verticalOffset)
        .attr("stroke", "#ccc");

      // Adiciona os n√≥s
      const nodes = svg.selectAll(".node")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.x},${d.y + verticalOffset})`);

      nodes.append("circle")
        .attr("r", 10)
        .attr("fill", "#69b3a2");

      nodes.append("text")
        .attr("dy", -15)
        .attr("text-anchor", "middle")
        .text(d => d.data.value || "Node");

      // Interatividade: ao passar o mouse sobre um n√≥
      nodes.on("mouseover", function (event, d) {
        d3.select(this)
          .select("circle")
          .attr("fill", "#ff7f0e");
      }).on("mouseout", function (event, d) {
        d3.select(this)
          .select("circle")
          .attr("fill", "#69b3a2");
      });
    }
  </script>
</body>
</html>
