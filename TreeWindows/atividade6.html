<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de 츼rvores</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://d3js.org/d3.v7.min.js"></script> <!-- Carregando D3.js -->
</head>

<body>
  <h1>Editor de Estruturas de 츼rvores</h1>
  
  <div class="container">
    <div class="editor-container">
      <textarea id="code-editor" placeholder="Escreva seu c칩digo TypeScript aqui..."></textarea>
      <button id="run-code">Executar C칩digo</button>
    </div>
    
    <div id="output-container">
      <h2>Visualiza칞칚o da 츼rvore</h2>
      <div id="tree-output"></div>
      <div class="celebration" id="celebration" style="display: none;">
        游꾽 Parab칠ns! Voc칡 acertou! 游꾽
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/typescript@4.9.4/lib/typescript.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // C칩digo TypeScript para inicializar no editor
      const initialCode = `
      class Node {
          value: string;
          children: Node[];
  
          constructor(value: string) {
              this.value = value;
              this.children = [];
          }
  
          // M칠todo para adicionar um filho
          addChild(child: Node): void {
              this.children.push(child);
          }
      }
  
      // Fun칞칚o para criar a 치rvore 
      function createTaxonomyTree(): Node {
          const animalia = new Node("Animalia");
  
          const chordata = new Node("Chordata");
          animalia.addChild(chordata);
  
          const mammalia = new Node("Mammalia");
          chordata.addChild(mammalia);
  
          const primates = new Node("Primates");
          mammalia.addChild(primates);
          primates.addChild(new Node("Homo sapiens"));
  
          const carnivora = new Node("Carnivora");
          mammalia.addChild(carnivora);
          carnivora.addChild(new Node("Canis lupus"));
  
          const aves = new Node("Aves");
          chordata.addChild(aves);
  
          const passeriformes = new Node("Passeriformes");
          aves.addChild(passeriformes);
          passeriformes.addChild(new Node("Corvus corax"));
  
          return animalia; // Retorna a 치rvore completa
      }
  
      // Fun칞칚o para converter a 치rvore para a estrutura "value" e "children"
      function convertToTreeNode(node: Node): any {
          return {
              value: node.value,
              children: node.children.map(child => convertToTreeNode(child)), // Converte recursivamente os filhos
          };
      }
  
      // Fun칞칚o de busca
      function searchNode(root: Node, value: string): Node | undefined {
          if (root.value === value) {
              return root;
          }
          for (const child of root.children) {
              const found = searchNode(child, value);
              if (found) {
                  return found;
              }
          }
          return undefined;
      }
  
      // Fun칞칚o que retorna a 치rvore
      function getTaxonomyTree(): { tree: any } {
          const taxonomyRoot = createTaxonomyTree();
  
          return {
              tree: convertToTreeNode(taxonomyRoot)
          };
      }
  
      // Chamando a fun칞칚o para obter os dados
      getTaxonomyTree();
      `;
  
      // Inicializa o editor com o c칩digo
      document.getElementById("code-editor").value = initialCode;
  
      // Simula o clique no bot칚o para executar o c칩digo
      document.getElementById("run-code").click();
    });
  </script>
  
  <script>
    document.getElementById("run-code")?.addEventListener("click", () => {
      const userCode = document.getElementById("code-editor")?.value;
      const outputDiv = document.getElementById("tree-output");
      const celebrationDiv = document.getElementById("celebration");

      if (userCode && outputDiv) {
        try {
          // Limpa a 치rvore existente antes de renderizar uma nova
          outputDiv.innerHTML = "";

          // Compila o c칩digo TypeScript para JavaScript
          const compiledCode = ts.transpile(userCode);
          
          // Executa o c칩digo compilado utilizando eval
          const result = eval(compiledCode);
          
          // Renderiza a 치rvore no elemento de sa칤da com D3
          if (result && result.tree) {
            renderTreeD3(result.tree, outputDiv);
          }
        } catch (error) {
          outputDiv.innerHTML = `<span style="color: red;">Erro: ${error.message}</span>`;
        }
      }
    });

    // Fun칞칚o para renderizar a 치rvore com D3.js
    function renderTreeD3(tree, container) {
      const width = 600;
      const height = 300;
      const verticalOffset = 50; // Ajuste conforme necess치rio

      const svg = d3.select(container)
        .append("svg")
        .attr("width", width)
        .attr("height", height + verticalOffset);

      const root = d3.hierarchy(tree); // Usando a estrutura hier치rquica do D3

      const treeLayout = d3.tree().size([width, height - 100]);

      treeLayout(root); // Calculando as posi칞칫es dos n칩s

      // Adiciona os links entre os n칩s
      svg.selectAll(".link")
        .data(root.links())
        .enter()
        .append("line")
        .attr("class", "link")
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y + verticalOffset)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y + verticalOffset)
        .attr("stroke", "#ccc");

      // Adiciona os n칩s
      const nodes = svg.selectAll(".node")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.x},${d.y + verticalOffset})`);

      nodes.append("circle")
        .attr("r", 10)
        .attr("fill", "#69b3a2");

      nodes.append("text")
        .attr("dy", -15)
        .attr("text-anchor", "middle")
        .text(d => d.data.value || "Node");

      // Interatividade: ao passar o mouse sobre um n칩
      nodes.on("mouseover", function (event, d) {
        d3.select(this)
          .select("circle")
          .attr("fill", "#ff7f0e");
      }).on("mouseout", function (event, d) {
        d3.select(this)
          .select("circle")
          .attr("fill", "#69b3a2");

        
        
      });
    }

    // Fun칞칚o para remover um n칩 da 치rvore
    function removeNode(root, value) {
      if (!root) return null;

      // Se o n칩 for encontrado e for o valor desejado, retorne null (remover)
      if (root.data.value === value) {
        return null;
      }

      // Recurre nos filhos para remover o n칩
      if (root.children) {
        root.children = root.children.map(child => removeNode(child, value)).filter(child => child !== null);
      }
      return root;
    }
  </script>
</body>
</html>
